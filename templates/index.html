{% extends "base.html" %}

{% block content %}
<div class="titan-dashboard-grid">

    <!-- Left Column: Scanner & Main View -->
    <div>
        <div class="hero-section" style="text-align: left; padding: 20px 0; position: relative;">

            <!-- Header Glitch Effect -->
            <h1 class="hero-title crt-flicker titan-hero-text">
                <span class="text-cyan">TITAN</span> PROTOCOL
            </h1>
            <p class="hero-subtitle" style="margin-left: 24px; font-family: var(--font-mono); color: var(--text-dim);">
                <span style="color: var(--neon-magenta);">>> SYSTEM READY</span> // TARGET ACQUISITION ONLINE
            </p>

            <!-- Terminal Form -->
            <form action="/" method="post" class="titan-input-wrapper">
                <div style="position: relative; margin-bottom: 20px;">
                    <input type="text" name="url" class="titan-terminal-input" placeholder="Enter target URL to scan..."
                        required autocomplete="off" value="{{ url if url else '' }}" style="padding-left: 15px;">
                </div>

                <button type="submit" class="titan-btn-glitch" style="margin-top: 10px;">
                    [ INITIATE SCAN ]
                </button>

                <!-- Advanced Toggles -->
                <input type="hidden" name="include_layered_analysis" value="true">
                <input type="hidden" name="use_combined_analysis" value="true">
            </form>
        </div>

        {% if result %}
        {% if result.error %}
        <div class="verdict-card" style="border-top: 4px solid var(--neon-red); text-align: left; padding: 30px;">
            <h2 style="color: var(--neon-red);">Analysis Failed</h2>
            <p>{{ result.error }}</p>
        </div>
        {% else %}
        <!-- Detailed Result Display -->
        <div class="verdict-card {{ result.classification.lower() }}" style="text-align: left;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                    <span class="verdict-badge">{{ result.verdict }}</span>
                    {% if result.classification == 'Safe' %}
                    <h2>Target Secure</h2>
                    <p style="color: var(--text-secondary);">No threat indicators detected.</p>
                    {% elif result.classification == 'Malicious' or result.classification == 'Phishing' %}
                    <h2 style="color: var(--neon-red);">Active Threat Detected</h2>
                    <p style="color: var(--text-secondary);">Access blocked by Guardian Protocol.</p>
                    {% else %}
                    <h2 style="color: var(--titan-gold);">Suspicious Activity</h2>
                    <p style="color: var(--text-secondary);">Caution advised.</p>
                    {% endif %}
                </div>
                <div style="text-align: right;">
                    <div class="{{ 'text-danger' if result.score > 50 else 'text-safe' }}"
                        style="font-size: 48px; font-weight: 900;">
                        {{ result.score }}
                    </div>
                    <div style="font-size: 12px; color: var(--text-muted);">RISK SCORE</div>
                </div>
            </div>

            <div class="stats-grid" style="margin-top: 30px;">
                <div class="stat-card">
                    <div class="stat-label">Confidence</div>
                    <div class="stat-value">{{ result.confidence }}%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Latency</div>
                    <div class="stat-value">~18ms</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Engine</div>
                    <div class="stat-value" style="color: var(--neon-blue);">TITAN V3</div>
                </div>
            </div>

            <!-- Hex Grid Analysis -->
            {% if result.breakdown %}
            <div style="margin-top: 30px; height: 300px;">
                <canvas id="risk-radar" data-labels='{{ chart_labels | tojson | safe }}'
                    data-scores='{{ chart_data | tojson | safe }}'>
                </canvas>
            </div>
            {% endif %}

            <!-- compact risk list -->
            {% if result.risks %}
            <div style="margin-top: 30px;">
                <h4 style="color: var(--text-muted); margin-bottom: 15px;">DETECTED VECTORS</h4>
                {% for category, data in result.risks.items() %}
                {% if data[1] %}
                {% for risk in data[1] %}
                <div
                    style="padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between;">
                    <span style="font-family: 'JetBrains Mono', monospace; color: var(--text-primary);">{{ risk[0]
                        }}</span>
                    <span style="color: var(--neon-red);">+{{ risk[1] }}</span>
                </div>
                {% endfor %}
                {% endif %}
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% endif %}
        {% endif %}
    </div>

    <!-- Right Column: 3D Hologram & Intel Feed -->
    <div style="display: flex; flex-direction: column; gap: 20px;">

        <!-- 3D THREAT GLOBE CONTAINER -->
        <div id="titan-globe-container" class="titan-panel" style="height: 300px; width: 100%; position: relative;">
            <div
                style="position: absolute; top: 10px; left: 10px; z-index: 10; font-size: 10px; color: var(--neon-cyan);">
                LIVE THREAT MAP // GLOBAL
            </div>
        </div>

        <!-- Recent Intel -->
        <div class="titan-panel" style="padding: 20px; flex-grow: 1;">
            <h3
                style="margin-bottom: 20px; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted);">
                Recent Intelligence
            </h3>

            {% if recent_history %}
            {% for entry in recent_history %}
            <a href="/history/{{ entry.id }}" style="text-decoration: none; display: block; margin-bottom: 10px;">
                <div class="{{ 'border-safe' if entry.classification == 'Safe' else 'border-danger' }}"
                    style="background: rgba(255,255,255,0.02); padding: 15px; border-radius: 8px; transition: background 0.2s;">
                    <div
                        style="font-size: 14px; color: var(--text-primary); margin-bottom: 5px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        {{ entry.url }}
                    </div>
                    <div
                        style="display: flex; justify-content: space-between; font-size: 11px; color: var(--text-muted);">
                        <span>{{ entry.timestamp[:16].replace('T', ' ') }}</span>
                        <span class="{{ 'text-safe' if entry.classification == 'Safe' else 'text-danger' }}">{{
                            entry.classification }}</span>
                    </div>
                </div>
            </a>
            {% endfor %}
            {% else %}
            <div style="color: var(--text-muted); font-size: 13px; font-style: italic;">No recent scans active.</div>
            {% endif %}
        </div>
    </div>

</div>

<!-- Load Titan Engines -->
<script>
    // Inject backend result for the Cyber Agent
    window.serverResult = {{ result | tojson | safe if result else 'null' }};
</script>
<script src="{{ url_for('static', filename='js/titan-globe.js') }}"></script>
<script src="{{ url_for('static', filename='js/titan-charts.js') }}"></script>
<script src="{{ url_for('static', filename='js/app.js') }}"></script>
<script src="{{ url_for('static', filename='js/cyber-agent.js') }}"></script>
{% endblock %}