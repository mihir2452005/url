{% extends "base.html" %}
{% block content %}

<!-- AI Agent & Search Section -->
<div class="row justify-content-center mb-5">
    <div class="col-md-8 text-center">

        <!-- Agent Visualization -->
        <div class="agent-container mb-4" id="agent-visual">
            <div class="agent-core"></div>
            <div class="agent-ring ring-1"></div>
            <div class="agent-ring ring-2"></div>
            <div class="agent-ring ring-3"></div>
        </div>

        <h3 class="mb-3 font-mono" id="agent-status-text">SYSTEM READY // AWAITING INPUT</h3>

        <!-- Search Form -->
        <div class="card-cyber p-4">
            <form method="POST" id="analyze-form">
                <div class="input-group input-group-lg mb-3">
                    <span class="input-group-text bg-transparent border-secondary text-neon-blue font-mono">></span>
                    <input type="url" class="form-control form-control-cyber" id="url" name="url"
                        placeholder="ENTER URL FOR ANALYSIS..." required value="{{ url if url else '' }}"
                        autocomplete="off">
                    <button type="submit" class="btn btn-cyber">INITIATE SCAN</button>
                </div>

                <div class="d-flex justify-content-center gap-4 mt-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input bg-dark border-secondary" type="checkbox"
                            id="include_layered_analysis" name="include_layered_analysis" value="true" {% if
                            include_layered_analysis is not defined or include_layered_analysis %}checked{% endif %}>
                        <label class="form-check-label text-secondary font-mono small"
                            for="include_layered_analysis">LAYERED_SCAN</label>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input bg-dark border-secondary" type="checkbox"
                            id="use_combined_analysis" name="use_combined_analysis" value="true" {% if
                            use_combined_analysis is not defined or use_combined_analysis %}checked{% endif %}>
                        <label class="form-check-label text-secondary font-mono small"
                            for="use_combined_analysis">AI_COMBINED_MODE</label>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

{% if result %}
<!-- PASS BACKEND RESULT TO FRONTEND JS -->
<script>
    window.serverResult = {{ result | tojson | safe }};
</script>

<!-- New Dashboard Layout -->
<div class="row g-4 fade-in-up">
    <!-- Left Column: Score & Stats -->
    <div class="col-lg-4">
        <!-- Main Verdict Card -->
        <div class="card-cyber p-4 h-100 text-center">
            <h5 class="text-secondary font-mono mb-4">THREAT_ASSESSMENT_GAUGE</h5>

            <div class="risk-gauge-container">
                <div class="risk-gauge-arc" id="risk-gauge-arc"></div>
                <div class="risk-score-display display-1 fw-bold text-white mb-0" id="risk-score-display">0</div>
            </div>

            <h2 class="mt-4 mb-2 text-white">{{ result.classification|upper }}</h2>
            <div class="badge bg-transparent border border-secondary text-secondary font-mono mb-3">
                CONFIDENCE: {{ result.confidence|round(1) }}%
            </div>

            <!-- Parameters Summary -->
            <div class="d-flex justify-content-around mt-4 pt-3 border-top border-secondary">
                <div class="stat-box">
                    <div class="stat-value text-white" id="stat-total-checks">0</div>
                    <div class="stat-label">TOTAL PARAMS</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value text-neon-red" id="stat-failed-checks">0</div>
                    <div class="stat-label">ANOMALIES</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column: Detailed Breakdown -->
    <div class="col-lg-8">
        <!-- AI Explanation Card -->
        <div class="card-cyber p-4 mb-4">
            <h5 class="text-neon-blue font-mono mb-2"> <i class="bi bi-robot"></i> AGENT_INSIGHT</h5>
            <p class="mb-0 text-light lead fs-6 font-mono" id="ai-explanation">
                Loading analysis interpretation...
            </p>
        </div>

        <!-- Category Breakdown -->
        <div class="card-cyber p-4">
            <h5 class="text-secondary font-mono mb-4">DETAILED_VECTOR_ANALYSIS</h5>

            <div class="row">
                {% for cat, data in result.breakdown.items() %}
                <div class="col-md-6 mb-4">
                    <div class="d-flex justify-content-between align-items-end mb-1">
                        <span class="font-mono text-uppercase small text-light">{{ cat }}</span>
                        <span class="text-neon-blue small">{{ data.weighted|round(1) }} RISK</span>
                    </div>

                    <!-- Progress Bar -->
                    <div class="category-progress">
                        <!-- Width and color handled by CSS variables to appease linters -->
                        <div class="category-bar bg-gradient"
                            style="--bar-width: {{ [data.weighted * 2, 5]|max }}%; --bar-bg: {{ 'var(--neon-green)' if data.weighted < 10 else 'var(--neon-red)' }}">
                        </div>
                    </div>

                    <!-- Expandable Details -->
                    <div class="mt-2">
                        <details>
                            <summary class="text-secondary small font-mono">VIEW LOGS</summary>
                            <ul class="list-unstyled mt-2 small text-light ps-3 border-start border-secondary">
                                {% for name, wt, expl in data.details %}
                                {% if wt > 0 %}
                                <li class="mb-1 text-neon-red">
                                    [!] {{ name }}: {{ expl }}
                                </li>
                                {% else %}
                                <li class="mb-1 text-muted">
                                    [âˆš] {{ name }}
                                </li>
                                {% endif %}
                                {% endfor %}
                            </ul>
                        </details>
                    </div>
                </div>
                {% endfor %}
            </div>

            {% if result.ml_analysis %}
            <hr class="border-secondary my-4">
            <h5 class="text-neon-purple font-mono mb-3">MACHINE_LEARNING_PREDICTION</h5>
            <div class="p-3 border border-secondary rounded" style="background: rgba(188, 19, 254, 0.05);">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <span class="d-block font-mono text-uppercase">MODEL VERDICT</span>
                        <strong class="fs-4 text-light">{{ result.ml_analysis.prediction }}</strong>
                    </div>
                    <div>
                        <span class="d-block font-mono text-uppercase">CONFIDENCE</span>
                        <strong class="fs-4 text-neon-purple">{{ (result.ml_analysis.confidence * 100)|round(1)
                            }}%</strong>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

<div class="alert alert-dark border-secondary mt-5" role="alert">
    <div class="d-flex align-items-center">
        <div class="text-neon-yellow fs-3 me-3"><i class="bi bi-shield-lock"></i></div>
        <div>
            <h6 class="alert-heading font-mono text-neon-yellow">INTELLIGENCE AUGMENTATION // RESEARCH EDITION</h6>
            <small class="text-light">
                Engineered for advanced threat modeling and educational analysis.
                This system leverages experimental heuristic algorithms to detect complex attack vectors.
                Designed to augment human security analysts, not replace comprehensive defense protocols.
            </small>
        </div>
    </div>
</div>

<style>
    /* Animation ensure */
    .fade-in-up {
        animation: fadeInUp 0.5s ease-out forwards;
        opacity: 0;
        transform: translateY(20px);
    }

    @keyframes fadeInUp {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

{% endblock %}