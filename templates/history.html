{% extends "base.html" %}

{% block content %}
<div class="container" style="max-width: 1400px;">
    <!-- Header -->
    <div style="text-align: center; margin-bottom: 50px;">
        <h1 class="hero-title" style="font-size: 42px;">Intelligence Archive</h1>
        <p class="hero-subtitle">Comprehensive logs of all intercepted vectors.</p>
    </div>

    <!-- Stats HUD -->
    <div class="stats-grid" style="margin-bottom: 50px;">
        <div class="stat-card">
            <div class="stat-label">Total Scans</div>
            <div class="stat-value">{{ stats.total_analyses }}</div>
        </div>
        <div class="stat-card" style="border-color: var(--neon-green);">
            <div class="stat-label" style="color: var(--neon-green);">Secure</div>
            <div class="stat-value glow-text-green">{{ stats.safe_count }}</div>
        </div>
        <div class="stat-card" style="border-color: var(--titan-gold);">
            <div class="stat-label" style="color: var(--titan-gold);">Suspicious</div>
            <div class="stat-value">{{ stats.suspicious_count }}</div>
        </div>
        <div class="stat-card" style="border-color: var(--neon-red);">
            <div class="stat-label" style="color: var(--neon-red);">Threats</div>
            <div class="stat-value glow-text-red">{{ stats.malicious_count + stats.phishing_count }}</div>
        </div>
    </div>

    <!-- Controls -->
    <div class="verdict-card"
        style="padding: 20px; text-align: left; margin-bottom: 30px; display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
        <form method="GET" action="{{ url_for('history_search') }}" style="display: flex; gap: 10px; flex: 1;">
            <input type="text" name="q" class="titan-input" placeholder="Search archive..."
                value="{{ search_query or '' }}"
                style="background: var(--bg-deep); border: var(--glass-border); padding: 10px; font-size: 14px;">
            <select name="verdict" class="titan-input"
                style="background: var(--bg-deep); border: var(--glass-border); padding: 10px; font-size: 14px; width: auto;">
                <option value="">All Verdicts</option>
                <option value="Safe" {% if search_verdict=='Safe' %}selected{% endif %}>Safe</option>
                <option value="Suspicious" {% if search_verdict=='Suspicious' %}selected{% endif %}>Suspicious</option>
                <option value="Malicious" {% if search_verdict=='Malicious' %}selected{% endif %}>Malicious</option>
            </select>
            <button type="submit" class="titan-btn-scan" style="position: static; padding: 10px 20px;">FILTER</button>
        </form>

        <form method="POST" action="{{ url_for('clear_history') }}"
            onsubmit="return confirm('Purge entire database?');">
            <button type="submit"
                style="background: transparent; border: 1px solid var(--neon-red); color: var(--neon-red); padding: 10px 20px; border-radius: 8px; cursor: pointer;">PURGE
                ARCHIVE</button>
        </form>
    </div>

    <!-- Data Grid -->
    {% if history %}
    <div style="background: var(--bg-panel); border-radius: 12px; border: var(--glass-border); overflow: hidden;">
        <table style="width: 100%; border-collapse: collapse; text-align: left;">
            <thead>
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.02);">
                    <th style="padding: 15px; color: var(--text-muted); font-size: 12px; letter-spacing: 1px;">TIMESTAMP
                    </th>
                    <th style="padding: 15px; color: var(--text-muted); font-size: 12px; letter-spacing: 1px;">TARGET
                    </th>
                    <th style="padding: 15px; color: var(--text-muted); font-size: 12px; letter-spacing: 1px;">VERDICT
                    </th>
                    <th style="padding: 15px; color: var(--text-muted); font-size: 12px; letter-spacing: 1px;">RISK</th>
                    <th style="padding: 15px; color: var(--text-muted); font-size: 12px; letter-spacing: 1px;">ACTION
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for entry in history %}
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05); transition: background 0.2s;">
                    <td
                        style="padding: 15px; font-family: 'JetBrains Mono', monospace; color: var(--text-secondary); font-size: 13px;">
                        {{ entry.timestamp[:16].replace('T', ' ') }}</td>
                    <td style="padding: 15px; font-family: 'JetBrains Mono', monospace;">
                        <span
                            style="color: var(--text-primary); display: block; max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{
                            entry.url }}</span>
                    </td>
                    <td style="padding: 15px;">
                        {% if entry.verdict == 'Safe' %}
                        <span
                            style="color: var(--neon-green); background: rgba(0,255,157,0.1); padding: 5px 10px; border-radius: 4px; font-size: 12px; font-weight: 700;">SAFE</span>
                        {% elif entry.verdict == 'Suspicious' %}
                        <span
                            style="color: var(--titan-gold); background: rgba(255,215,0,0.1); padding: 5px 10px; border-radius: 4px; font-size: 12px; font-weight: 700;">SUSP</span>
                        {% else %}
                        <span
                            style="color: var(--neon-red); background: rgba(255,42,109,0.1); padding: 5px 10px; border-radius: 4px; font-size: 12px; font-weight: 700;">THREAT</span>
                        {% endif %}
                    </td>
                    <td style="padding: 15px;">
                        <div
                            style="font-weight: 700; color: {{ 'var(--neon-red)' if entry.score > 70 else 'var(--text-primary)' }};">
                            {{ entry.score }}</div>
                    </td>
                    <td style="padding: 15px;">
                        <a href="{{ url_for('history_detail', entry_id=entry.id) }}"
                            style="color: var(--neon-blue); text-decoration: none; font-size: 13px; font-weight: 500; margin-right: 15px;">DETAILS</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if total_pages > 1 %}
    <div style="text-align: center; margin-top: 30px;">
        {% if page > 1 %}
        <a href="{{ url_for('history', page=page-1) }}"
            style="color: var(--text-secondary); text-decoration: none; margin: 0 10px;">&laquo; Prev</a>
        {% endif %}
        <span style="color: var(--neon-blue);">PAGE {{ page }} OF {{ total_pages }}</span>
        {% if page < total_pages %} <a href="{{ url_for('history', page=page+1) }}"
            style="color: var(--text-secondary); text-decoration: none; margin: 0 10px;">Next &raquo;</a>
            {% endif %}
    </div>
    {% endif %}

    {% else %}
    <div style="text-align: center; padding: 50px; color: var(--text-muted);">
        <p>No intelligence records found.</p>
    </div>
    {% endif %}
</div>
{% endblock %}