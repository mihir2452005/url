{% extends "base.html" %}
{% block content %}

<!-- Navigation -->
<div class="row mb-4">
    <div class="col-md-12">
        <a href="{{ url_for('history') }}" class="btn btn-outline-secondary font-mono border-secondary text-light mb-3">
            <i class="bi bi-chevron-left"></i> RETURN TO LOGS
        </a>
        <h2 class="text-neon-blue font-mono glitch-text">TARGET ANALYSIS REPORT</h2>
        <p class="text-secondary font-mono small">ARCHIVED INTELLIGENCE RECORD: {{ entry.timestamp[:19].replace('T', '
            ') }}</p>
    </div>
</div>

<!-- Main Intelligence Card -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card-cyber p-4">
            <div class="d-flex justify-content-between align-items-center mb-4 border-bottom border-secondary pb-3">
                <h5 class="text-light font-mono mb-0">TARGET_VECTOR_DETAILS</h5>
                <span class="badge border border-{{ 'success' if entry.classification == 'Safe' else 'warning' if entry.classification == 'Suspicious' else 'danger' }} 
                             text-{{ 'success' if entry.classification == 'Safe' else 'warning' if entry.classification == 'Suspicious' else 'danger' }} 
                             bg-transparent font-mono fs-6">
                    {{ entry.classification|upper }}
                </span>
            </div>

            <!-- URL Display with Professional Input Group -->
            <div class="mb-4">
                <label class="text-secondary font-mono small mb-2">TARGET_URL</label>
                <div class="input-group">
                    <input type="text"
                        class="form-control form-control-cyber text-light font-mono bg-transparent border-secondary"
                        value="{{ entry.url }}" readonly title="{{ entry.url }}">
                    <button class="btn btn-outline-secondary border-secondary text-neon-blue font-mono js-copy-btn"
                        type="button" data-clipboard-text="{{ entry.url }}">
                        <i class="bi bi-clipboard"></i> COPY
                    </button>
                    <a href="{{ entry.url }}" target="_blank" rel="noopener noreferrer"
                        class="btn btn-outline-secondary border-secondary text-light font-mono">
                        <i class="bi bi-box-arrow-up-right"></i> VISIT
                    </a>
                </div>
            </div>

            <!-- Key Metrics Grid -->
            <div class="row g-4 mb-3">
                <div class="col-md-4">
                    <div class="p-3 border border-secondary rounded text-center"
                        style="background: rgba(255,255,255,0.02)">
                        <small class="text-secondary font-mono d-block mb-1">RISK SCORE</small>
                        <h3
                            class="font-mono {{ 'text-neon-green' if entry.score < 35 else 'text-neon-yellow' if entry.score < 75 else 'text-neon-red' }}">
                            {{ entry.score|round(1) }}<span class="fs-6 text-muted">/100</span>
                        </h3>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="p-3 border border-secondary rounded text-center"
                        style="background: rgba(255,255,255,0.02)">
                        <small class="text-secondary font-mono d-block mb-1">CONFIDENCE</small>
                        <h3 class="text-light font-mono">
                            {{ entry.confidence|round(1) }}<span class="fs-6 text-neon-blue">%</span>
                        </h3>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="p-3 border border-secondary rounded text-center"
                        style="background: rgba(255,255,255,0.02)">
                        <small class="text-secondary font-mono d-block mb-1">DATABASE ID</small>
                        <h3 class="text-secondary font-mono fs-5 pt-1">
                            #{{ entry.id }}
                        </h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Data -->
<div class="row">
    <div class="col-md-8">
        <div class="card-cyber p-4 h-100">
            <h5 class="text-secondary font-mono mb-4">DETAILED_RISK_BREAKDOWN</h5>

            {% if entry.risk_summary %}
            {% for category, data in entry.risk_summary.items() %}
            <div class="mb-3 border border-secondary rounded p-3" style="background: rgba(0,0,0,0.2);">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="font-mono text-uppercase text-light small">{{ category }}</span>
                    <span class="font-mono text-neon-blue small">{{ data.score|round(1) }} RISK</span>
                </div>

                <!-- Integrated Progress Bar (Refactored for CSS Variables) -->
                <div class="category-progress mb-3"
                    style="height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px;">
                    <div class="category-bar" style="--bar-width: {{ [data.score * 2, 5]|max }}%; 
                                    --bar-bg: {{ 'var(--neon-green)' if data.score < 20 else 'var(--neon-red)' }}; 
                                    height: 100%; border-radius: 2px;">
                    </div>
                </div>

                {% if data.details %}
                <ul class="list-unstyled mb-0 ps-2 border-start border-secondary small text-light font-mono">
                    {% for detail in data.details %}
                    <li class="mb-2">
                        <span class="text-neon-red">[!]</span> <strong>{{ detail.name }}</strong> (+{{ detail.weight
                        }}):
                        <span class="text-secondary">{{ detail.explanation }}</span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <small class="text-success font-mono ps-2 opacity-50"><i class="bi bi-check2"></i> NO ANOMALIES
                    DETECTED</small>
                {% endif %}
            </div>
            {% endfor %}
            {% else %}
            <div class="alert alert-dark border-secondary text-center">
                <p class="mb-0 text-secondary font-mono">NO GRANULAR DATA AVAILABLE FOR THIS RECORD.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Sidebar / Chart -->
    <div class="col-md-4">
        {% if chart_data %}
        <div class="card-cyber p-4 mb-4">
            <h5 class="text-secondary font-mono mb-4">VECTOR_DISTRIBUTION</h5>
            <div class="position-relative" style="height: 250px;">
                <canvas id="riskChart"></canvas>
            </div>
            <!-- Legend / Key -->
            <div class="mt-3 text-center">
                <small class="text-muted font-mono">Relative contribution to total risk score</small>
            </div>
        </div>
        {% endif %}

        <div class="card-cyber p-4 border-danger">
            <h5 class="text-danger font-mono mb-3">DANGER ZONE</h5>
            <p class="text-secondary small mb-3">Permanently remove this intelligence record from the archive.</p>
            <form method="POST" action="{{ url_for('delete_history_entry', entry_id=entry.id) }}"
                onsubmit="return confirm('WARNING: Irreversible action. Purge this record?');">
                <button type="submit" class="btn btn-outline-danger w-100 font-mono">
                    <i class="bi bi-trash"></i> DELETE RECORD
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Chart Script -->
{% if chart_data %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Pass data via data attributes or careful JSON encoding
        const breakdownKeys = {{ entry.breakdown.keys() | list | tojson | safe
    }};
    const breakdownData = {{ chart_data | tojson | safe }};
    const ctx = document.getElementById('riskChart')?.getContext('2d');

    if (ctx && typeof Chart !== 'undefined') {
        const chart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: breakdownKeys,
                datasets: [{
                    data: breakdownData,
                    backgroundColor: [
                        '#00f3ff', // Cyan
                        '#bc13fe', // Purple
                        '#00ff9d', // Green
                        '#ff2a6d', // Red
                        '#f3eb0d'  // Yellow
                    ],
                    borderColor: '#050508',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#8a8d91',
                            font: { family: "'Roboto Mono', monospace" }
                        }
                    }
                }
            }
        });
    }
});
</script>
{% endif %}

<script>
    console.log('History Detail page loaded');

    document.addEventListener('DOMContentLoaded', function () {
        // Event delegation for copy buttons
        document.body.addEventListener('click', function (e) {
            // Find closest button with js-copy-btn class
            const btn = e.target.closest('.js-copy-btn');
            if (!btn) return;

            const text = btn.getAttribute('data-clipboard-text');
            if (text) {
                copyToClipboard(text, btn);
            }
        });
    });

    function copyToClipboard(text, btnElement) {
        console.log('Copy requested for:', text);
        // Fallback for non-secure contexts (HTTP)
        if (!navigator.clipboard) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            textArea.style.top = "0";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                const successful = document.execCommand('copy');
                const msg = successful ? 'successful' : 'unsuccessful';
                console.log('Fallback copy result:', msg);
                showFeedback(btnElement, true);
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
                alert('Failed to copy URL. Please copy manually.');
            }

            document.body.removeChild(textArea);
            return;
        }

        // Modern API
        navigator.clipboard.writeText(text).then(() => {
            console.log('Clipboard API success');
            showFeedback(btnElement, true);
        }).catch(err => {
            console.error('Failed to copy: ', err);
            // Try fallback if modern API fails (e.g. permission denied)
            try {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px";
                textArea.style.top = "0";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showFeedback(btnElement, true);
            } catch (fallbackErr) {
                alert('Failed to copy URL to clipboard');
            }
        });
    }

    function showFeedback(btnElement, success) {
        const originalHtml = btnElement.innerHTML;
        const originalClass = btnElement.className;

        btnElement.innerHTML = '<i class="bi bi-check-lg"></i> COPIED';
        // Preserve original classes but add success state
        btnElement.classList.remove('btn-outline-secondary', 'text-neon-blue');
        btnElement.classList.add('btn-success', 'border-success', 'text-white');

        setTimeout(() => {
            btnElement.innerHTML = originalHtml;
            // Restore original classes
            btnElement.className = originalClass;
        }, 2000);
    }
</script>

{% endblock %}